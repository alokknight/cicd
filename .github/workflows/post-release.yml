name: Post Release Cleanup

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.4.5)'
        required: true
        type: string
      skip_merge:
        description: 'Skip merge to main (if already merged)'
        required: false
        type: boolean
        default: false
      skip_tag:
        description: 'Skip tagging (if tag already exists)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  issues: write

jobs:
  post-release:
    runs-on: ubuntu-latest
    steps:
      - name: Validate version format
        run: |
          if [[ ! "${{ inputs.version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must be in format vX.Y.Z (e.g., v1.4.5)"
            exit 1
          fi
          echo "Version format validated: ${{ inputs.version }}"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Verify release branch exists
        run: |
          if ! git ls-remote --heads origin release/${{ inputs.version }} | grep -q release/${{ inputs.version }}; then
            echo "Error: Release branch release/${{ inputs.version }} does not exist"
            exit 1
          fi
          echo "Release branch exists: release/${{ inputs.version }}"

      - name: Merge release to main
        if: ${{ !inputs.skip_merge }}
        run: |
          echo "=========================================="
          echo "Merging release/${{ inputs.version }} to main"
          echo "=========================================="

          git fetch origin main
          git fetch origin release/${{ inputs.version }}

          git checkout main
          git pull origin main

          # Merge with no-ff to preserve history
          git merge origin/release/${{ inputs.version }} --no-ff -m "Merge release/${{ inputs.version }} to main"

          git push origin main

          echo "Successfully merged release/${{ inputs.version }} to main"

      - name: Create version tag
        if: ${{ !inputs.skip_tag }}
        run: |
          echo "=========================================="
          echo "Creating tag ${{ inputs.version }} on main"
          echo "=========================================="

          git checkout main
          git pull origin main

          # Check if tag already exists
          if git tag -l | grep -q "^${{ inputs.version }}$"; then
            echo "Warning: Tag ${{ inputs.version }} already exists, skipping"
          else
            git tag -a ${{ inputs.version }} -m "Release ${{ inputs.version }}"
            git push origin ${{ inputs.version }}
            echo "Successfully created tag ${{ inputs.version }}"
          fi

      - name: Delete release branch
        run: |
          echo "=========================================="
          echo "Deleting release branch"
          echo "=========================================="

          # Delete remote branch
          git push origin --delete release/${{ inputs.version }} || echo "Branch may already be deleted"

          echo "Successfully deleted release/${{ inputs.version }}"

      - name: Find and close release issue
        uses: actions/github-script@v7
        env:
          VERSION: ${{ inputs.version }}
        with:
          script: |
            const version = process.env.VERSION;

            // Find issues with release label matching this version
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'release',
              state: 'open'
            });

            const releaseIssue = issues.data.find(issue =>
              issue.title.includes(version) || issue.title.includes(`Release ${version}`)
            );

            if (releaseIssue) {
              // Add completion comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: releaseIssue.number,
                body: `## Release ${version} Complete!

            ### Summary
            - [x] Merged to main
            - [x] Tagged as \`${version}\`
            - [x] Release branch deleted

            **Completed by:** @${context.actor}
            **Date:** ${new Date().toISOString()}

            ---
            This release is now complete. The release branch has been cleaned up.
            `
              });

              // Close the issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: releaseIssue.number,
                state: 'closed'
              });

              console.log(`Closed release issue #${releaseIssue.number}`);
            } else {
              console.log('No matching release issue found to close');
            }

      - name: Summary
        run: |
          echo ""
          echo "=========================================="
          echo "Post-Release Cleanup Complete"
          echo "=========================================="
          echo "Version: ${{ inputs.version }}"
          echo ""
          echo "Actions completed:"
          if [ "${{ inputs.skip_merge }}" != "true" ]; then
            echo "  - Merged release/${{ inputs.version }} to main"
          else
            echo "  - Skipped merge (as requested)"
          fi
          if [ "${{ inputs.skip_tag }}" != "true" ]; then
            echo "  - Created tag ${{ inputs.version }} on main"
          else
            echo "  - Skipped tagging (as requested)"
          fi
          echo "  - Deleted release/${{ inputs.version }} branch"
          echo "  - Closed release tracking issue"
          echo ""
          echo "Release ${{ inputs.version }} is now complete!"
          echo "=========================================="
