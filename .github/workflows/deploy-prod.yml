name: Deploy to Production

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy'
        required: true
        type: string

permissions:
  issues: write
  contents: read

env:
  PAT_TOKEN: ${{ secrets.PAT_TOKEN }}

jobs:
  deploy-prod:
    runs-on: ubuntu-latest
    # Trigger on: manual dispatch OR comment contains 'deploy' on issues with prod-deployment label
    if: |
      github.event_name == 'workflow_dispatch' ||
      (
        github.event_name == 'issue_comment' &&
        contains(github.event.issue.labels.*.name, 'prod-deployment') &&
        (
          contains(github.event.comment.body, 'deploy') ||
          contains(github.event.comment.body, 'Deploy') ||
          contains(github.event.comment.body, 'DEPLOY')
        )
      )

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract image tag from issue body
        id: extract
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          INPUT_TAG: ${{ inputs.image_tag }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          if [ "$EVENT_NAME" == "issue_comment" ]; then
            # Extract image tag from issue body (format: **Image Tag:** `tag-here`)
            IMAGE_TAG=$(echo "$ISSUE_BODY" | grep -oP '\*\*Image Tag:\*\*\s*`\K[^`]+' || echo "")
            if [ -z "$IMAGE_TAG" ]; then
              echo "Error: Could not extract image tag from issue body"
              exit 1
            fi
          else
            IMAGE_TAG="$INPUT_TAG"
          fi
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "Extracted image tag: ${IMAGE_TAG}"

      - name: Show Deployment Info
        run: |
          echo "=========================================="
          echo "ðŸš¨ Deploying to PRODUCTION environment..."
          echo "=========================================="
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "Triggered by: Issue comment"
            echo "User: ${{ github.event.comment.user.login }}"
            echo "Issue: #${{ github.event.issue.number }}"
          else
            echo "Triggered by: Manual workflow dispatch"
          fi
          echo "Image Tag: ${{ steps.extract.outputs.image_tag }}"
          echo "=========================================="

      - name: Trigger Terraform Production Deploy
        run: |
          curl -X POST \
            -H "Authorization: token ${{ env.PAT_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/aicentralone/Terraform/dispatches \
            -d '{
              "event_type": "prod-deploy-trigger",
              "client_payload": {
                "backend_image_tag": "${{ steps.extract.outputs.image_tag }}",
                "frontend_image_tag": "latest",
                "frontend2_image_tag": "latest",
                "target_env": "prod"
              }
            }'

      - name: Comment and Close Issue
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        env:
          IMAGE_TAG: ${{ steps.extract.outputs.image_tag }}
        with:
          script: |
            const imageTag = process.env.IMAGE_TAG;
            const actor = context.payload.comment.user.login;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            // Add completion comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `## ðŸš€ Production Deployment Triggered!

            | Field | Value |
            |-------|-------|
            | Image | \`${imageTag}\` |
            | Environment | **PRODUCTION** |
            | Triggered by | @${actor} |

            [View Workflow Run](${runUrl})

            ---
            âœ… This issue will be closed automatically.
            `
            });

            // Close the issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              state: 'closed'
            });

      - name: Summary
        run: |
          echo ""
          echo "=========================================="
          echo "ðŸš€ PRODUCTION Deployment Triggered"
          echo "=========================================="
          echo "Image Tag: ${{ steps.extract.outputs.image_tag }}"
          echo "Terraform deployment workflow dispatched"
          echo "=========================================="
