name: Promote to Production

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      backend_tag:
        description: 'Backend image tag'
        required: true
        type: string
      frontend_tag:
        description: 'Frontend image tag'
        required: true
        type: string
      community_tag:
        description: 'Community image tag'
        required: true
        type: string

permissions:
  issues: write
  contents: read

env:
  PAT_TOKEN: ${{ secrets.PAT_TOKEN }}

jobs:
  promote-prod:
    runs-on: ubuntu-latest
    # Trigger on: manual dispatch OR /promote-prod command on release issues
    if: |
      github.event_name == 'workflow_dispatch' ||
      (
        github.event_name == 'issue_comment' &&
        contains(github.event.issue.labels.*.name, 'release') &&
        (
          contains(github.event.comment.body, '/promote-prod') ||
          contains(github.event.comment.body, '/Promote-Prod') ||
          contains(github.event.comment.body, '/PROMOTE-PROD')
        )
      )

    steps:
      - name: Extract image tags from issue
        id: extract
        if: github.event_name == 'issue_comment'
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # Parse image tags from issue body table
          # Format: | Backend | `v1.4.5-abc1234` |
          BACKEND=$(echo "$ISSUE_BODY" | grep -oP 'Backend\s*\|\s*`\K[^`]+' | head -1 || echo "")
          FRONTEND=$(echo "$ISSUE_BODY" | grep -oP 'Frontend\s*\|\s*`\K[^`]+' | head -1 || echo "")
          COMMUNITY=$(echo "$ISSUE_BODY" | grep -oP 'Community\s*\|\s*`\K[^`]+' | head -1 || echo "")

          # Use latest if not specified
          [ -z "$BACKEND" ] && BACKEND="latest"
          [ -z "$FRONTEND" ] && FRONTEND="latest"
          [ -z "$COMMUNITY" ] && COMMUNITY="latest"

          echo "backend_tag=${BACKEND}" >> $GITHUB_OUTPUT
          echo "frontend_tag=${FRONTEND}" >> $GITHUB_OUTPUT
          echo "community_tag=${COMMUNITY}" >> $GITHUB_OUTPUT

          echo "Extracted tags:"
          echo "  Backend: $BACKEND"
          echo "  Frontend: $FRONTEND"
          echo "  Community: $COMMUNITY"

      - name: Set final tags
        id: tags
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "backend=${{ inputs.backend_tag }}" >> $GITHUB_OUTPUT
            echo "frontend=${{ inputs.frontend_tag }}" >> $GITHUB_OUTPUT
            echo "community=${{ inputs.community_tag }}" >> $GITHUB_OUTPUT
          else
            echo "backend=${{ steps.extract.outputs.backend_tag }}" >> $GITHUB_OUTPUT
            echo "frontend=${{ steps.extract.outputs.frontend_tag }}" >> $GITHUB_OUTPUT
            echo "community=${{ steps.extract.outputs.community_tag }}" >> $GITHUB_OUTPUT
          fi

      - name: Production Deployment Warning
        run: |
          echo "=========================================="
          echo "       PRODUCTION DEPLOYMENT"
          echo "=========================================="
          echo ""
          echo "This will deploy to PRODUCTION environment!"
          echo ""
          echo "Services being deployed:"
          echo "  Backend:   ${{ steps.tags.outputs.backend }}"
          echo "  Frontend:  ${{ steps.tags.outputs.frontend }}"
          echo "  Community: ${{ steps.tags.outputs.community }}"
          echo ""
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "Triggered by: @${{ github.event.comment.user.login }}"
            echo "Issue: #${{ github.event.issue.number }}"
          else
            echo "Triggered by: Manual workflow dispatch"
          fi
          echo "=========================================="

      - name: Trigger Terraform Production Deploy (All Repos)
        run: |
          curl -X POST \
            -H "Authorization: token ${{ env.PAT_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/aicentralone/Terraform/dispatches \
            -d '{
              "event_type": "prod-deploy-trigger",
              "client_payload": {
                "backend_image_tag": "${{ steps.tags.outputs.backend }}",
                "frontend_image_tag": "${{ steps.tags.outputs.frontend }}",
                "frontend2_image_tag": "${{ steps.tags.outputs.community }}",
                "target_env": "prod"
              }
            }'

      - name: Comment on Issue
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        env:
          BACKEND_TAG: ${{ steps.tags.outputs.backend }}
          FRONTEND_TAG: ${{ steps.tags.outputs.frontend }}
          COMMUNITY_TAG: ${{ steps.tags.outputs.community }}
        with:
          script: |
            const backendTag = process.env.BACKEND_TAG;
            const frontendTag = process.env.FRONTEND_TAG;
            const communityTag = process.env.COMMUNITY_TAG;
            const actor = context.payload.comment.user.login;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `## PRODUCTION Deployment Triggered (All Repos)

            | Service | Image Tag |
            |---------|-----------|
            | Backend | \`${backendTag}\` |
            | Frontend | \`${frontendTag}\` |
            | Community | \`${communityTag}\` |

            **Triggered by:** @${actor}

            [View Workflow Run](${runUrl})

            ---
            ## Post-Deployment Checklist

            - [ ] Verify all services are healthy
            - [ ] Check application logs for errors
            - [ ] Monitor metrics for anomalies
            - [ ] 1-day monitoring period

            After successful monitoring, run the **Post Release Cleanup** workflow to:
            - Merge release branch to main
            - Create version tag
            - Delete release branch
            `
            });

      - name: Summary
        run: |
          echo ""
          echo "=========================================="
          echo "PRODUCTION Deployment Triggered"
          echo "=========================================="
          echo "Backend:   ${{ steps.tags.outputs.backend }}"
          echo "Frontend:  ${{ steps.tags.outputs.frontend }}"
          echo "Community: ${{ steps.tags.outputs.community }}"
          echo ""
          echo "Terraform deployment workflow dispatched"
          echo ""
          echo "Post-deployment:"
          echo "1. Monitor application health"
          echo "2. After 1-day monitoring, run post-release workflow"
          echo "=========================================="
