name: Promote to QA

on:
  workflow_dispatch:
    inputs:
      notify_qa:
        description: 'Send email notification to QA team'
        required: false
        default: true
        type: boolean
      build_version:
        description: 'Build version or commit to deploy'
        required: false
        default: 'latest'
        type: string

permissions:
  issues: write
  contents: read

jobs:
  # ============================================
  # STAGE 1: Deploy to QA
  # ============================================
  deploy-qa:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to QA Environment
        run: |
          echo "=========================================="
          echo "üöÄ Deploying to QA environment..."
          echo "=========================================="
          echo "Build Version: ${{ inputs.build_version }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Promoted by: ${{ github.actor }}"
          sleep 3
          echo "‚úÖ QA deployment completed!"

  # ============================================
  # STAGE 2: Notify QA Team (Optional)
  # ============================================
  notify-qa-team:
    runs-on: ubuntu-latest
    needs: deploy-qa
    if: ${{ inputs.notify_qa == true }}
    steps:
      - name: Create QA Notification Issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ÔøΩÔøΩ New Build Ready for QA Testing',
              body: `## New Build Deployed to QA

            **Build Details:**
            - Version: \`${{ inputs.build_version }}\`
            - Commit: \`${{ github.sha }}\`
            - Promoted by: @${{ github.actor }}
            - Workflow Run: [View Details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ---

            ‚úÖ **QA Environment is ready for testing!**

            Please test and close this issue when done.

            /cc @alokknight
            `,
              labels: ['qa-testing']
            });

  # ============================================
  # STAGE 3: Wait for QA Approval (for Prod)
  # ============================================
  approval-for-prod:
    runs-on: ubuntu-latest
    needs: deploy-qa
    steps:
      - name: Request Approval for Production
        uses: trstringer/manual-approval@v1
        with:
          approvers: alokknight
          secret: ${{ github.token }}
          minimum-approvals: 1
          issue-title: "üöÄ Approve deployment to PRODUCTION"
          issue-body: |
            **Production Deployment Approval Request**

            QA deployment completed. Ready to deploy to Production.

            **Details:**
            - Build Version: `${{ inputs.build_version }}`
            - Commit: `${{ github.sha }}`
            - Promoted by: @${{ github.actor }}

            ---

            ‚úÖ **To approve:** Comment `approved`
            ‚ùå **To reject:** Comment `denied`
          exclude-workflow-initiator-as-approver: false

  # ============================================
  # STAGE 4: Deploy to Production (after approval)
  # ============================================
  deploy-prod:
    runs-on: ubuntu-latest
    needs: approval-for-prod
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Production
        run: |
          echo "=========================================="
          echo "üöÄ Deploying to PRODUCTION..."
          echo "=========================================="
          echo "Build Version: ${{ inputs.build_version }}"
          echo "Commit: ${{ github.sha }}"
          echo "Approved by: ${{ github.actor }}"
          sleep 3
          echo "‚úÖ PRODUCTION deployment completed!"
          echo ""
          echo "üéâ Full promotion complete: DEV ‚Üí QA ‚Üí PROD"
