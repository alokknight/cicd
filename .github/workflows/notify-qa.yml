name: Request QA Story Testing

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Staging image tag (e.g., staging-abc1234)'
        required: true
        type: string
      stories:
        description: 'Story/ticket numbers being tested (e.g., TICKET-123, TICKET-456)'
        required: true
        type: string
      build_notes:
        description: 'Notes about this build (features, fixes, etc.)'
        required: false
        type: string

permissions:
  issues: write
  contents: read

jobs:
  notify-qa:
    runs-on: ubuntu-latest
    steps:
      - name: Validate inputs
        run: |
          if [[ ! "${{ inputs.image_tag }}" =~ ^staging- ]]; then
            echo "Warning: Image tag doesn't start with 'staging-'. Expected staging image for story testing."
          fi

      - name: Create QA Story Testing Issue
        uses: actions/github-script@v7
        env:
          IMAGE_TAG: ${{ inputs.image_tag }}
          STORIES: ${{ inputs.stories }}
          BUILD_NOTES: ${{ inputs.build_notes }}
          ACTOR: ${{ github.actor }}
        with:
          script: |
            const imageTag = process.env.IMAGE_TAG;
            const stories = process.env.STORIES;
            const buildNotes = process.env.BUILD_NOTES || 'No additional notes provided.';
            const actor = process.env.ACTOR;
            const date = new Date().toISOString();

            const body = `## Story Testing Request

            **Image Tag:** \`${imageTag}\`
            **Stories:** ${stories}
            **Requested by:** @${actor}
            **Date:** ${date}

            **Notes:**
            ${buildNotes}

            ---

            ## Actions

            | Command | Action |
            |---------|--------|
            | \`deploy\` | Deploy this image to QA environment |
            | \`passed\` | Mark all stories as passed |
            | \`failed\` | Mark testing as failed (with details) |

            ---

            ## Testing Checklist

            - [ ] Image deployed to QA
            - [ ] Stories tested: ${stories}
            - [ ] All acceptance criteria verified
            - [ ] No blockers found

            ---

            /cc @alokknight
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ§ª QA Story Testing: ${imageTag}`,
              body: body,
              labels: ['qa-story-testing']
            });

      - name: Summary
        run: |
          echo "=========================================="
          echo "QA Story Testing Request Created"
          echo "=========================================="
          echo "Image Tag: ${{ inputs.image_tag }}"
          echo "Stories: ${{ inputs.stories }}"
          echo "QA can comment 'deploy' on the issue to trigger deployment"
          echo "=========================================="
