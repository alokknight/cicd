name: Deploy to QA

on:
  # Trigger via issue comment (QA comments "deploy" or "approved")
  issue_comment:
    types: [created]
  # Also allow manual trigger from Actions page
  workflow_dispatch:
    inputs:
      build_version:
        description: 'Build version/tag to deploy'
        required: false
        default: 'latest'
        type: string

permissions:
  issues: write
  contents: read

jobs:
  deploy-qa:
    runs-on: ubuntu-latest
    # Only run if: manual trigger OR (issue has 'qa-ready' label AND comment contains deploy/approved)
    if: |
      github.event_name == 'workflow_dispatch' ||
      (
        github.event_name == 'issue_comment' &&
        contains(github.event.issue.labels.*.name, 'qa-ready') &&
        (
          contains(github.event.comment.body, 'deploy') ||
          contains(github.event.comment.body, 'Deploy') ||
          contains(github.event.comment.body, 'DEPLOY') ||
          contains(github.event.comment.body, 'approved') ||
          contains(github.event.comment.body, 'Approved') ||
          contains(github.event.comment.body, 'APPROVED')
        )
      )
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Show Trigger Info
        run: |
          echo "=========================================="
          echo "ðŸš€ Deploying to QA environment..."
          echo "=========================================="
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "Triggered by: Issue comment"
            echo "User: ${{ github.event.comment.user.login }}"
            echo "Issue: #${{ github.event.issue.number }}"
          else
            echo "Triggered by: Manual workflow dispatch"
            echo "Build Version: ${{ inputs.build_version }}"
          fi
          echo "Commit: ${{ github.sha }}"

      - name: Deploy to QA Environment
        run: |
          echo ""
          echo "Deploying..."
          sleep 3
          echo ""
          echo "âœ… QA deployment completed!"

      - name: Comment and Close Issue
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            // Add completion comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `âœ… **QA Deployment Complete!**

            Deployment triggered by @${context.payload.comment.user.login}

            [View Workflow Run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
            });

            // Close the issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              state: 'closed'
            });

            console.log('Issue closed successfully');

      - name: Summary
        run: |
          echo ""
          echo "=========================================="
          echo "âœ… QA Deployment Complete"
          echo "=========================================="
